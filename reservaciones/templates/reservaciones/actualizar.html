{% extends 'base.html' %}
{% load static %}
{% block title %}Actualizar Reservación{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'reservaciones/css/gestion_admin.css' %}">

<div class="container">

    <!-- ENCABEZADO -->
    <div class="header-admin">
        <div class="d-flex align-items-center">
            <img src="{% static 'reservaciones/img/LOGO.png' %}" alt="Logo">
            <h2>Actualizar Reservación</h2>
        </div>

        <a href="{% url 'gestion_admin' %}" class="btn btn-regresar">
            <i class="bi bi-arrow-left-circle"></i> Regresar al menú
        </a>
    </div>

    <!-- FORMULARIO DE ACTUALIZACIÓN -->
    <form method="POST" class="p-4 shadow-sm rounded-4" onsubmit="return validarFormulario()">
        {% csrf_token %}
        <div class="row g-3">

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Nombre del Cliente</label>
                <input type="text" name="nombreCliente" class="form-control" value="{{ reservacion.nombreCliente }}"
                    pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ ]+" title="El nombre solo puede contener letras y espacios." required>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Teléfono</label>
                <input type="text" name="telefono" class="form-control" value="{{ reservacion.telefono }}"
                    pattern="[0-9]{10}" title="El teléfono debe tener exactamente 10 dígitos y solo números." required>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Fecha del Evento</label>
                <input type="date" name="fechaEvento" class="form-control"
                    value="{{ reservacion.fechaEvento|date:'Y-m-d' }}"
                    title="Selecciona una fecha válida para el evento." required>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Número de Invitados</label>
                <input type="number" name="numInvitados" class="form-control" value="{{ reservacion.numInvitados }}"
                    min="1" max="50" title="El número de invitados debe ser entre 1 y 50." required>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Tipo de Evento</label>
                <select name="tipoEvento" class="form-select" required>
                    {% for valor, nombre in tipos_evento %}
                    <option value="{{ valor }}" {% if reservacion.tipoEvento == valor %}selected{% endif %}>
                        {{ nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-semibold text-secondary">Estatus</label>
                <select name="estatus" class="form-select">
                    {% if reservacion.estatus == "pendiente" %}
                    <option value="pendiente" selected>Pendiente</option>
                    {% else %}
                    <option value="pendiente">Pendiente</option>
                    {% endif %}

                    {% if reservacion.estatus == "confirmada" %}
                    <option value="confirmada" selected>Confirmada</option>
                    {% else %}
                    <option value="confirmada">Confirmada</option>
                    {% endif %}

                    {% if reservacion.estatus == "realizada" %}
                    <option value="realizada" selected>Realizada</option>
                    {% else %}
                    <option value="realizada">Realizada</option>
                    {% endif %}
                </select>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-actualizar">
                <i class="bi bi-check-circle"></i> Guardar Cambios
            </button>
            <a href="{% url 'gestion_admin' %}" class="btn btn-regresar ms-2">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<script>
    function validarFormulario(event) {
        const fechaEventoInput = document.querySelector('input[name="fechaEvento"]');
        const valor = fechaEventoInput.value;

        // Evita validaciones si no hay fecha
        if (!valor) return true;

        // Convertir correctamente sin afectar la zona horaria
        const partes = valor.split('-'); // [año, mes, día]
        const fechaEvento = new Date(partes[0], partes[1] - 1, partes[2]); // local
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        if (fechaEvento < hoy) {
            fechaEventoInput.setCustomValidity("La fecha del evento no puede ser anterior a la fecha actual.");
            fechaEventoInput.reportValidity();
            event.preventDefault();
            return false;
        } else {
            fechaEventoInput.setCustomValidity("");
        }

        return true;
    }

    // Asociar función al submit del formulario
    document.querySelector('form').addEventListener('submit', validarFormulario);
</script>

{% endblock %}
